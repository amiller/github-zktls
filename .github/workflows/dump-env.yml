name: Dump Runner Environment
on: workflow_dispatch

jobs:
  dump-clean:
    name: Clean runner baseline
    runs-on: ubuntu-latest
    steps:
      - name: Env var names (sorted)
        run: env | cut -d= -f1 | sort
      - name: Full env dump
        run: env | sort

  test-guard:
    name: Test env confinement guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Environment confinement check
        run: |
          REF=".github/allowed-env-reference.txt"

          # Strip comments and blank lines from reference
          grep -v '^#' "$REF" | grep -v '^$' | sort -u > /tmp/allowed.txt

          # Current env var names
          env | cut -d= -f1 | sort -u > /tmp/current.txt

          # Anything present that's not in the allowed list?
          UNEXPECTED=$(comm -23 /tmp/current.txt /tmp/allowed.txt || true)

          if [ -n "$UNEXPECTED" ]; then
            echo "::error::Unexpected environment variables detected!"
            echo "The following vars are NOT in .github/allowed-env-reference.txt:"
            echo "$UNEXPECTED"
            echo ""
            echo "This could indicate env injection (LD_PRELOAD, NODE_OPTIONS, etc)."
            echo "If these are legitimate, add them to allowed-env-reference.txt."
            exit 1
          fi

          echo "Environment confinement check passed."
          echo "$(wc -l < /tmp/current.txt) vars present, all in allowed list."
