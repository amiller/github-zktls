# Email Identity Challenge
#
# Phase 1 of email verification. Triggered when someone opens an issue
# with [EMAIL] in the title.
#
# Generates a random token, embeds it in a "magic link" that pre-fills
# a new GitHub issue, and emails the link. The user clicks ‚Üí submits ‚Üí
# Phase 2 triggers. The token is never visually displayed to the user.
#
# TRUST MODEL:
#   - Token generated inside GitHub Actions (can't be intercepted)
#   - SES sends email but doesn't store body contents
#   - Workflow code is auditable + pinned by Sigstore
#   - Anyone can be the notary ‚Äî just host this workflow + SES creds
#
# REQUIRED SECRETS:
#   - AWS_ACCESS_KEY_ID + AWS_SECRET_ACCESS_KEY (SES SendRawEmail)
#   - SES_FROM_EMAIL (verified sender address)
#   - AWS_REGION (e.g. us-east-2)
#
# ISSUE FORMAT:
#   Title: [EMAIL] Claim email NFT
#   Body:
#     email: user@example.com
#     recipient: 0x1234...

name: Email Challenge

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  send-challenge:
    if: contains(github.event.issue.title, '[EMAIL]')
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            const emailMatch = body.match(/email:\s*(\S+@\S+\.\S+)/i);
            if (!emailMatch) {
              core.setFailed('No email found. Use format: email: user@example.com');
              return;
            }
            const email = emailMatch[1].toLowerCase();

            const addrMatch = body.match(/recipient:\s*(0x[a-fA-F0-9]{40})/i);
            if (!addrMatch) {
              core.setFailed('No recipient address found. Use format: recipient: 0x...');
              return;
            }
            const recipient = addrMatch[1].toLowerCase();

            core.setOutput('email', email);
            core.setOutput('recipient', recipient);
            console.log(`Email: ${email}`);
            console.log(`Recipient: ${recipient}`);

      - name: Generate challenge token
        id: challenge
        run: |
          # 32-byte random token (64 hex chars) ‚Äî embedded in link, never shown to user
          TOKEN=$(openssl rand -hex 32)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

          HASH=$(echo -n "$TOKEN" | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Send verification email
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        run: |
          FROM="${{ secrets.SES_FROM_EMAIL }}"
          TO="${{ steps.parse.outputs.email }}"
          TOKEN="${{ steps.challenge.outputs.token }}"
          RECIPIENT="${{ steps.parse.outputs.recipient }}"
          ISSUE_NUM="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"

          # Build the magic link: clicking it opens a pre-filled GitHub issue
          TITLE=$(python3 -c "import urllib.parse; print(urllib.parse.quote('[EMAIL-VERIFY] #${ISSUE_NUM}'))")
          BODY=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${TOKEN}'))")
          VERIFY_LINK="https://github.com/${REPO}/issues/new?title=${TITLE}&body=${BODY}"

          ADDR_SHORT="${RECIPIENT:0:6}...${RECIPIENT: -4}"

          # HTML email with verify button
          RAW_MSG="From: ${FROM}
          To: ${TO}
          Subject: Verify your email for ${ADDR_SHORT}
          MIME-Version: 1.0
          Content-Type: text/html; charset=UTF-8

          <div style=\"max-width:480px;margin:0 auto;font-family:-apple-system,sans-serif;padding:20px\">
            <h2 style=\"margin-top:0\">Verify your email</h2>
            <p>A request was made to link <strong>${TO}</strong> to Ethereum address:</p>
            <p style=\"font-family:monospace;background:#f5f5f5;padding:10px;border-radius:4px;word-break:break-all\">${RECIPIENT}</p>
            <p>Click below to confirm. This will open a GitHub page where you submit the verification.</p>
            <p style=\"text-align:center;margin:24px 0\">
              <a href=\"${VERIFY_LINK}\" style=\"display:inline-block;background:#2ea44f;color:#fff;padding:12px 32px;border-radius:6px;text-decoration:none;font-weight:600;font-size:16px\">Verify My Email</a>
            </p>
            <p style=\"color:#666;font-size:13px\">If you did not request this, ignore this email. This link expires in 1 hour.</p>
            <hr style=\"border:none;border-top:1px solid #eee;margin:20px 0\">
            <p style=\"color:#999;font-size:11px\">Sent from <a href=\"https://github.com/${REPO}\">${REPO}</a> via GitHub Actions</p>
          </div>"

          B64_MSG=$(echo "$RAW_MSG" | base64 -w 0)
          aws ses send-raw-email \
            --raw-message "Data=$B64_MSG" \
            --region "${{ secrets.AWS_REGION }}"

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const hash = '${{ steps.challenge.outputs.hash }}';
            const timestamp = '${{ steps.challenge.outputs.timestamp }}';
            const email = '${{ steps.parse.outputs.email }}';
            const recipient = '${{ steps.parse.outputs.recipient }}';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                `## üìß Verification email sent!`,
                ``,
                `Check your inbox and click the link to verify.`,
                ``,
                `<details>`,
                `<summary>Verification metadata (for auditors)</summary>`,
                ``,
                `- Challenge hash: \`${hash}\``,
                `- Email: \`${email}\``,
                `- Recipient: \`${recipient}\``,
                `- Timestamp: \`${timestamp}\``,
                `- Run ID: \`${context.runId}\``,
                `- Expires: 1 hour`,
                `</details>`
              ].join('\n')
            });

            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['email-pending']
            });

      - name: Comment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Challenge Failed\n\nCould not send verification email. Check issue format:\n\`\`\`\nemail: user@example.com\nrecipient: 0x1234...\n\`\`\``
            });
