# Sealed Box: Multi-Attestation Demo
#
# Demonstrates that multiple attest-build-provenance calls in a single
# workflow run share the same run_id and commit sha — proving they came
# from the same trusted execution context.
#
# Flow:
#   1. Generate ephemeral RSA-2048 keypair (openssl)
#   2. Attest the public key (ATTESTATION 1)
#   3. Upload pubkey artifact + create temp issue as message bus
#   4. Wait for encrypted submissions via issue comments
#   5. Decrypt all submissions with the ephemeral private key (RSA-OAEP)
#   6. Attest the results (ATTESTATION 2)
#   7. Upload result artifact, close issue, destroy private key
#
# Designed for local CLI use via examples/sealed-box/sealed-box.sh
# The issue is just a message bus — all UX happens in the terminal.

name: Sealed Box

on:
  workflow_dispatch:
    inputs:
      window_minutes:
        description: 'Minutes to accept submissions'
        default: '5'

permissions:
  id-token: write
  contents: read
  attestations: write
  issues: write

jobs:
  sealed-box:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate ephemeral keypair
        run: |
          openssl genrsa -out key.pem 2048 2>/dev/null
          openssl rsa -in key.pem -pubout -out pubkey.pem 2>/dev/null
          echo "Generated RSA-2048 keypair"

      - name: Create pubkey certificate
        run: |
          mkdir -p sealed-box
          WINDOW="${{ inputs.window_minutes }}"
          TS="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          jq -n \
            --rawfile pubkey pubkey.pem \
            --arg window "$WINDOW" \
            --arg ts "$TS" \
            --arg run "$RUN_URL" \
            '{type:"sealed-box-pubkey", pubkey_pem:$pubkey, window_minutes:($window|tonumber), timestamp:$ts, workflow_run:$run}' \
            > sealed-box/pubkey.json
          cat sealed-box/pubkey.json

      # === ATTESTATION 1: Public key ===
      - name: Attest public key
        id: attest_pubkey
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: sealed-box/pubkey.json

      # Upload pubkey immediately so local script can download mid-run
      - name: Upload pubkey artifact
        uses: actions/upload-artifact@v4
        with:
          name: sealed-box-pubkey
          path: sealed-box/pubkey.json

      # Create a disposable issue as a message bus for encrypted submissions
      - name: Create message bus issue
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SEALED-BOX] run ${context.runId}`,
              body: `attestation: ${{ steps.attest_pubkey.outputs.attestation-url }}`,
              labels: ['sealed-box']
            });
            core.setOutput('number', issue.number);
            console.log(`Message bus: issue #${issue.number}`);

      - name: Wait for submissions
        run: |
          echo "Sealed box open for ${{ inputs.window_minutes }} minutes"
          echo "Message bus: issue #${{ steps.issue.outputs.number }}"
          sleep $(( ${{ inputs.window_minutes }} * 60 ))

      - name: Collect and decrypt submissions
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            const issueNumber = ${{ steps.issue.outputs.number }};

            const comments = await github.rest.issues.listComments({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const encrypted = comments.data.filter(c =>
              c.body.includes('-----BEGIN SEALED BOX MESSAGE-----') &&
              c.user.login !== 'github-actions[bot]'
            );
            console.log(`Found ${encrypted.length} encrypted submission(s)`);

            const results = [];
            for (const comment of encrypted) {
              const match = comment.body.match(/-----BEGIN SEALED BOX MESSAGE-----([\s\S]*?)-----END SEALED BOX MESSAGE-----/);
              if (!match) continue;

              const cipherB64 = match[1].trim();
              fs.writeFileSync('/tmp/encrypted.bin', Buffer.from(cipherB64, 'base64'));
              try {
                const plaintext = execSync(
                  'openssl pkeyutl -decrypt -inkey key.pem -pkeyopt rsa_padding_mode:oaep -in /tmp/encrypted.bin',
                  { encoding: 'utf8', timeout: 10000 }
                ).trim();
                results.push({ from: comment.user.login, comment_id: comment.id, plaintext });
                console.log(`Decrypted: ${comment.user.login}`);
              } catch (e) {
                results.push({ from: comment.user.login, comment_id: comment.id, error: 'decryption_failed' });
              }
            }

            const pubkeyJson = JSON.parse(fs.readFileSync('sealed-box/pubkey.json', 'utf8'));
            const result = {
              type: 'sealed-box-result',
              pubkey_pem: pubkeyJson.pubkey_pem,
              issue: issueNumber,
              submission_count: results.length,
              submissions: results,
              opened: pubkeyJson.timestamp,
              closed: new Date().toISOString(),
              workflow_run: pubkeyJson.workflow_run
            };
            fs.writeFileSync('sealed-box/result.json', JSON.stringify(result, null, 2));
            console.log(JSON.stringify(result, null, 2));

      # === ATTESTATION 2: Results ===
      - name: Attest results
        id: attest_result
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: sealed-box/result.json

      - name: Destroy private key
        run: shred -u key.pem

      - name: Upload result artifact
        uses: actions/upload-artifact@v4
        with:
          name: sealed-box-result
          path: sealed-box/result.json

      - name: Close message bus issue
        uses: actions/github-script@v7
        with:
          script: |
            const attestUrl = '${{ steps.attest_result.outputs.attestation-url }}';
            await github.rest.issues.createComment({
              issue_number: ${{ steps.issue.outputs.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `sealed-box-result: ${attestUrl}`
            });
            await github.rest.issues.update({
              issue_number: ${{ steps.issue.outputs.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
