# Session Notes: 2026-02-03 - ZK GitHub Attestation Research

## Goal
Make GitHub Actions proofs verifiable on-chain via ZKP, enabling trustless NFT issuance.

## Session 2 Summary (continued)

### Completed
1. **Fulcio Intermediate CA Key** - Extracted P-384 public key from `https://fulcio.sigstore.dev/api/v2/trustBundle`
   - Saved to `docs/fulcio-intermediate-ca.md`
   - Valid: Apr 2022 - Oct 2031

2. **Witness Generator** (`zk-github-attestation/js/`)
   - Parses Sigstore bundle JSON
   - Computes DSSE PAE encoding
   - Decodes DER ECDSA signature ‚Üí (r, s)
   - Extracts P-256 public key from X.509 certificate
   - Signature verification passes with noble/curves

3. **Noir Circuit Scaffold** (`zk-github-attestation/circuits/`)
   - Uses `sha256` v0.1.2 for variable-length hashing
   - Uses stdlib `ecdsa_secp256r1` for P-256 verification
   - Compiles successfully with nargo 1.0.0-beta.5
   - Public inputs: `artifact_hash`, `repo_hash`, `commit_sha`

4. **P-384 Reference** - Found zkpassport circuits in `refs/circuits/`
   - `verify_nist_p384` function ready to use
   - Dependencies: `zkpassport/noir-ecdsa`, `noir-bignum`, `noir_bigcurve`

### Issue Encountered & FIXED
- Proof generation was failing with "Leaf signature verification failed"
- **Root cause**: Noir's `ecdsa_secp256r1::verify_signature` requires **low-s normalized** signatures
- Sigstore signatures can have high-s values (s > order/2)
- **Fix**: Added signature normalization in `decodeECDSASignature()` - if `s > order/2`, set `s = order - s`

### Session 3: PROOF GENERATION WORKS!
- Fixed signature normalization
- Installed `@noir-lang/noir_js@1.0.0-beta.5` and `@aztec/bb.js@0.84.0`
- Created `prove.ts` script using NoirJS + UltraHonk backend
- **Successfully generated and verified ZK proof!**
  - Proof size: 14,080 bytes
  - Circuit: ~42k ACIR opcodes
  - Uses UltraHonk (fast prover, small proof)

### Session 4: P-384 Cert Chain Added!
- **Upgraded nargo to 1.0.0-beta.18** (needed for zkpassport deps)
- **Added P-384 ECDSA verification using zkpassport libraries:**
  - `ecdsa@v0.2.9`, `bignum@v0.8.0-2`, `bigcurve@v0.11.0-1`, `sha512@v0.1.0`
- **Updated witness generator** (`js/src/index.ts`):
  - Extracts Certificate TBS (To Be Signed) - 1669 bytes
  - Extracts issuer signature (P-384) from X.509 cert
  - Added low-s normalization for P-384 signatures
- **Both verifications pass:**
  - JS: `verifySignature()` (P-256) and `verifyCertChain()` (P-384) both return true
  - Circuit: `nargo execute` succeeds (witness generated)
- **Circuit stats:** 256k ACIR opcodes (6x larger due to P-384)
- **Version conflict for proving:** nargo beta.18 needs matching bb.js but zkpassport's sha512 needs older nargo

### Current State
| Component | Status |
|-----------|--------|
| P-256 leaf signature | ‚úÖ Working |
| P-384 cert chain | ‚úÖ Working (in circuit) |
| Witness generation | ‚úÖ Working |
| ZK proof generation | ‚úÖ **WORKING!** |

### Session 5: TOOLCHAIN RESOLVED + SOLIDITY VERIFIER! üéâ

**Working Toolchain:**
| Component | Version |
|-----------|---------|
| nargo | `1.0.0-beta.17` |
| bb.js | `3.0.0-rc.5` |
| noir_js | `1.0.0-beta.17` |

**Proof Generated:**
- Public inputs: 84
- Proof fields: 508
- Proof size: 16,256 bytes
- Verified: ‚úÖ true
- Saved to: `circuits/proof.json`

**Key Fixes Applied:**
1. Downgraded from beta.18 to beta.17
2. Used bb.js 3.0.0-rc.5 (released around same time as beta.17)
3. Patched local sha512 lib (`std::wrapping_add` ‚Üí `h[j].wrapping_add(c[j])`)
4. Added `use std::ops::WrappingAdd;` import
5. Updated prove.ts to use WASM backend explicitly: `Barretenberg.new({ backend: BackendType.Wasm })`

**Local Patches (in libs/):**
- `libs/sha512/` - Fixed wrapping_add syntax for newer Noir

**Solidity Verifier Generated:**
- `contracts/GitHubAttestationVerifier.sol` - Auto-generated HonkVerifier (2449 lines)
- `contracts/GitHubAttestation.sol` - Wrapper contract for attestation verification
- VK size: 1888 bytes
- Circuit size: 524288 (2^19)
- Public inputs: 100 (artifact_hash + repo_hash + commit_sha as bytes)

**Scripts:**
- `js/src/generate-verifier.ts` - Generates Solidity verifier from circuit
- `js/src/format-proof.ts` - Formats proof for on-chain submission

### Version Troubleshooting Notes (Historical)

**Versions Tried:**
| nargo | bb.js | Result |
|-------|-------|--------|
| 1.0.0-beta.5 | 0.84.0 | ‚úÖ Works for P-256 only circuit |
| 1.0.0-beta.5 | 0.84.0 | ‚ùå zkpassport deps fail to compile (macro issues) |
| 1.0.0-beta.18 | 0.82.2 | ‚ùå WASM unreachable error |
| 1.0.0-beta.18 | 4.0.0-nightly.20260131 | ‚ùå sha512 lib uses old `std::wrapping_add` |
| **1.0.0-beta.17** | **3.0.0-rc.5** | ‚úÖ **WORKS!** |

**Key Dependencies:**
```toml
sha256 = { tag = "v0.2.1", git = "https://github.com/noir-lang/sha256" }
sha512 = { path = "../libs/sha512" }  # Local patched version
ecdsa = { tag = "v0.2.9", git = "https://github.com/zkpassport/noir-ecdsa" }
bignum = { tag = "v0.8.0-2", git = "https://github.com/zkpassport/noir-bignum" }
bigcurve = { tag = "v0.11.0-1", git = "https://github.com/zkpassport/noir_bigcurve" }
```

**Commands to Resume:**
```bash
# Install correct nargo version
noirup -v 1.0.0-beta.17

# Compile circuit (from circuits dir)
cd zk-github-attestation/circuits && ~/.nargo/bin/nargo compile

# Test witness generation
~/.nargo/bin/nargo execute

# Run JS tests (both P-256 and P-384)
cd ../js && npx tsx src/test.ts

# Try proving
npx tsx src/prove.ts
```

### TODO for Next Session
- [x] ~~Resolve toolchain version alignment for proving~~ ‚úÖ Done!
- [ ] Parse X.509 extensions in circuit to extract OIDC claims
- [ ] Generate Solidity verifier for on-chain verification
- [ ] Deploy verifier contract and test on-chain verification

## Completed This Session

### 1. Sample Attestation Captured
- Added `actions/attest-build-provenance@v2` to `attestation-test.yml` workflow
- Ran workflow, downloaded Sigstore bundle via GitHub API
- Saved to `docs/examples/sample-attestation-bundle.json`
- Analyzed certificate structure in `docs/examples/attestation-analysis.md`

**Key findings:**
- Signature: ECDSA P-256 (leaf cert)
- Certificate issuer: ECDSA P-384 (Fulcio intermediate)
- OIDC claims in X.509 extensions (OID `1.3.6.1.4.1.57264.1.*`)
- Contains: repo, workflow path, commit SHA, runner environment, run URL

### 2. zkEmail Repos Cloned
```
refs/zk-email-verify/  - Circom version (original)
refs/zkemail-noir/     - Noir version (what we'll adapt)
```

### 3. Noir Toolchain Setup
- Installed `nargo 1.0.0-beta.5` (required by zkemail-noir)
- Successfully compiled `verify_email_2048_bit_dkim` example
- Compiled circuit at: `refs/zkemail-noir/examples/verify_email_2048_bit_dkim/target/`

## Architecture Comparison

| zkEmail | Our Project |
|---------|-------------|
| RSA DKIM signature | ECDSA P-256 Sigstore signature |
| Email headers | DSSE envelope |
| DNS public key | Fulcio certificate chain |
| Email body hash | Artifact hash (sha256) |
| Selector/domain | Repository/workflow |

## Key Files

**Our Implementation:**
- `zk-github-attestation/circuits/src/main.nr` - Noir circuit (P-256 + P-384)
- `zk-github-attestation/circuits/Nargo.toml` - Dependencies
- `zk-github-attestation/js/src/index.ts` - Witness generator
- `zk-github-attestation/js/src/test.ts` - JS verification tests
- `zk-github-attestation/js/src/prove.ts` - NoirJS prover

**Reference:**
- `refs/zkemail-noir/` - zkEmail Noir implementation
- `refs/circuits/src/noir/lib/sig-check/ecdsa/` - zkpassport P-384 ECDSA
- `docs/examples/sample-attestation-bundle.json` - Real Sigstore bundle
- `docs/examples/attestation-analysis.md` - Certificate structure
- `docs/fulcio-intermediate-ca.md` - Fulcio CA public key

## OIDC Claims to Extract (Next Step)

In X.509 certificate extensions (OID `1.3.6.1.4.1.57264.1.*`):

| OID | Field | Use Case |
|-----|-------|----------|
| .3 | **commit SHA** | Verify exact code version |
| .5 | **repository** | Verify repo (e.g., `amiller/github-zktls`) |
| .6 | **ref** | Verify branch (e.g., `refs/heads/master`) |
| .1 | **issuer** | Verify OIDC issuer is GitHub Actions |

**Parsing approach:** Search for OID byte pattern, extract UTF8String value after it.

## Next Steps

1. **Get Fulcio intermediate CA public key** - Need to hardcode or fetch from TUF
2. **Build TypeScript input generator** - Parse Sigstore bundle ‚Üí circuit witness
3. **Build Noir circuit:**
   - Use `ecdsa_secp256r1::verify_signature` (native Noir)
   - Parse DSSE envelope (compute PAE encoding)
   - Extract OIDC claims from certificate
4. **Solidity verifier** - Deploy Groth16/UltraPlonk verifier

## Commands Reference

```bash
# Noir version
noirup -v 1.0.0-beta.5
~/.nargo/bin/nargo --version

# Compile zkEmail example
cd refs/zkemail-noir/examples/verify_email_2048_bit_dkim
~/.nargo/bin/nargo compile

# Get attestation for an artifact
gh api /repos/amiller/github-zktls/attestations/sha256:$(sha256sum proof.tar | cut -d' ' -f1)
```

## TODO
- [ ] Fix browser-container Docker to use prebuilt image (wastes CI time)
- [x] Get Fulcio intermediate CA public key ‚Üí `docs/fulcio-intermediate-ca.md`
- [ ] Create `zk-github-attestation/` directory with Noir circuit
- [x] TypeScript witness generator for Sigstore bundles ‚Üí `zk-github-attestation/js/`

## P-384 Reference
Found ZKPassport circuits in `refs/circuits/` with P-384 ECDSA:
- `refs/circuits/src/noir/lib/sig-check/ecdsa/src/lib.nr` - `verify_nist_p384` function
- Dependencies: `noir-ecdsa`, `noir-bignum`, `noir_bigcurve`
